name: Weekly Status to Discord

on:
  schedule:
    # HÃ©tfÅ‘ 07:00 UTC (hazai idÅ‘ben nyÃ¡ron 09:00, tÃ©len 08:00). ÃtÃ­rhatÃ³.
    - cron: "0 7 * * MON"
  workflow_dispatch:

jobs:
  weekly:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    env:
      GH_TOKEN: ${{ github.token }}   # gh CLI-hez
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build weekly summary
        id: summary
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          DEFAULT_BRANCH="$(gh repo view "$REPO" --json defaultBranchRef --jq .defaultBranchRef.name)"
          OPEN_ISSUES="$(gh issue list --state open --json number --jq 'length' || echo 0)"
          OPEN_PRS="$(gh pr list --state open --json number --jq 'length' || echo 0)"
          MERGED_PRS="$(gh pr list --state merged --json number --jq 'length' || echo 0)"
          CLOSED_ISSUES="$(gh issue list --state closed --search 'closed:>=-7d' --json number --jq 'length' || echo 0)"
          COMMITS="$(gh api repos/$REPO/commits --paginate -F sha="$DEFAULT_BRANCH" -f since="$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)" --jq 'length' || echo 0)"
          LAST_RELEASE="$(gh release list --limit 1 --json tagName,publishedAt --jq '.[0] // {}' || echo '{}')"
          REL_TAG="$(echo "$LAST_RELEASE" | jq -r '.tagName // "â€”"')"
          REL_DATE="$(echo "$LAST_RELEASE" | jq -r '.publishedAt // "â€”"')"

          PRS_URL="https://github.com/$REPO/pulls"
          ISSUES_URL="https://github.com/$REPO/issues"
          ACTIONS_URL="https://github.com/$REPO/actions"
          COMMITS_URL="https://github.com/$REPO/commits/$DEFAULT_BRANCH"
          RELEASES_URL="https://github.com/$REPO/releases"

          echo "text<<MSG" >> $GITHUB_OUTPUT
          echo "ðŸ“Š **Hickory â€“ heti stÃ¡tusz**" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "â€¢ Repo: **$REPO**  |  Branch: **$DEFAULT_BRANCH**" >> $GITHUB_OUTPUT
          echo "â€¢ Nyitott PR-k: **$OPEN_PRS**  |  Nyitott issue-k: **$OPEN_ISSUES**" >> $GITHUB_OUTPUT
          echo "â€¢ MÃºlt hÃ©ten merge-Ã¶lt PR-k: **$MERGED_PRS**  |  ZÃ¡rt issue-k (7d): **$CLOSED_ISSUES**" >> $GITHUB_OUTPUT
          echo "â€¢ Commitok (7d): **$COMMITS**" >> $GITHUB_OUTPUT
          echo "â€¢ UtolsÃ³ release: **$REL_TAG** (_$REL_DATE_)" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "ðŸ”— HivatkozÃ¡sok:" >> $GITHUB_OUTPUT
          echo "  â€¢ PR-k: $PRS_URL" >> $GITHUB_OUTPUT
          echo "  â€¢ Issue-k: $ISSUES_URL" >> $GITHUB_OUTPUT
          echo "  â€¢ Commitok: $COMMITS_URL" >> $GITHUB_OUTPUT
          echo "  â€¢ Actions futÃ¡sok: $ACTIONS_URL" >> $GITHUB_OUTPUT
          echo "  â€¢ Release-ek: $RELEASES_URL" >> $GITHUB_OUTPUT
          echo "MSG" >> $GITHUB_OUTPUT

      - name: Send to Discord
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: ${{ steps.summary.outputs.text }}
